<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.12.0 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Kaggle Toxic Classification (1) EDA - Inspiring People</title>
<meta name="description" content="Introduction">



<meta property="og:type" content="article">
<meta property="og:locale" content="ko">
<meta property="og:site_name" content="Inspiring People">
<meta property="og:title" content="Kaggle Toxic Classification (1) EDA">
<meta property="og:url" content="http://localhost:4000/data%20analysis/Toxic_EDA/">


  <meta property="og:description" content="Introduction">



  <meta property="og:image" content="http://localhost:4000/assets/img/teaser.png">





  <meta property="article:published_time" content="2018-10-09T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/data%20analysis/Toxic_EDA/">





  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://localhost:4000",
      "logo": "http://localhost:4000/assets/img/teaser.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "YounKyung Jang",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Inspiring People Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Inspiring People</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/categories/" >Category</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/tags/" >Tag</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/archive/" >Archive</a>
            </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/img/profile.jpg" alt="YounKyung Jang" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">YounKyung Jang</h3>
    
    
      <p class="author__bio" itemprop="description">
        자세히 보아야 아름답다. 너도 그렇다
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      

      

      
        <li>
          <a href="mailto:ykjang@gmail.com">
            <meta itemprop="email" content="ykjang@gmail.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/InspiringPeople" itemprop="sameAs">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      
        
          <li>
            <a href="https://youtube.com/dearpiano" itemprop="sameAs">
              <i class="fab fa-fw fa-youtube" aria-hidden="true"></i> YouTube
            </a>
          </li>
        
      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>  

  
    <div class="author__avatar2">
      

      
        <img src="/assets/img/profile2.jpg" alt="YounKyung Jang" itemprop="image">
      
    </div>
  
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Kaggle Toxic Classification (1) EDA">
    <meta itemprop="description" content="Introduction">
    <meta itemprop="datePublished" content="October 09, 2018">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Kaggle Toxic Classification (1) EDA
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#definition--library--functions">Definition  (Library &amp; Functions)</a></li>
  <li><a href="#class-imbalance">Class Imbalance</a></li>
  <li><a href="#correlation-plot">Correlation Plot</a></li>
  <li><a href="#word-cloud">Word Cloud</a></li>
  <li><a href="#feature-engineering">Feature Engineering</a></li>
  <li><a href="#corpus-cleansing">Corpus Cleansing</a></li>
  <li><a href="#baseline-model">Baseline Model</a></li>
  <li><a href="#이-커널의-check-point">이 커널의 Check Point</a></li>
  <li><a href="#reference">Reference</a></li>
</ul>
            </nav>
          </aside>
        
        <h2 id="introduction">Introduction</h2>

<ul>
  <li>
    <p>Wikipedia에서 제공된 대량의 데이터 셋이 있고 이 중 clean한 comments와 toxcid 관련 comments가 섞여 있다. (사람이 라벨링)  이 중에서 toxic 관련 라벨 데이터는 6개 가지 라벨 종류로 되어 있고 한 comments에 대해 여러 라벨이 태깅될 수 있다. Test dataset에 대해 아래와 같은 라벨로 구분하는 모델을 만드는 것이 Toxic Classification  목적</p>
  </li>
  <li>
    <p>Labels : toxic, severe_toxic, obscene, threat, insult, identity_hate</p>
  </li>
  <li>
    <p>link : https://www.kaggle.com/c/jigsaw-toxic-comment-classification-challenge</p>
  </li>
</ul>

<h2 id="definition--library--functions">Definition  (Library &amp; Functions)</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#import required packages</span>
<span class="c">#basics</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c">#misc</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c">#stats</span>
<span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="n">ss</span>

<span class="c">#viz</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="n">gridspec</span> 
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">from</span> <span class="nn">wordcloud</span> <span class="kn">import</span> <span class="n">WordCloud</span> <span class="p">,</span><span class="n">STOPWORDS</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib_venn</span> <span class="k">as</span> <span class="n">venn</span>

<span class="c">#nlp</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">re</span>    <span class="c">#for regex</span>
<span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="kn">import</span> <span class="n">stopwords</span>
<span class="kn">import</span> <span class="nn">spacy</span>
<span class="kn">from</span> <span class="nn">nltk</span> <span class="kn">import</span> <span class="n">pos_tag</span>
<span class="kn">from</span> <span class="nn">nltk.stem.wordnet</span> <span class="kn">import</span> <span class="n">WordNetLemmatizer</span> 
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">word_tokenize</span>
<span class="c"># Tweet tokenizer does not split at apostophes which is what we want</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">TweetTokenizer</span>   


<span class="c">#FeatureEngineering</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">TfidfVectorizer</span><span class="p">,</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">HashingVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">TruncatedSVD</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">check_X_y</span><span class="p">,</span> <span class="n">check_is_fitted</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">log_loss</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>





<span class="c">#settings</span>
<span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">color</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s">"dark"</span><span class="p">)</span>
<span class="n">eng_stopwords</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s">"english"</span><span class="p">))</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s">"ignore"</span><span class="p">)</span>

<span class="n">lem</span> <span class="o">=</span> <span class="n">WordNetLemmatizer</span><span class="p">()</span>
<span class="n">tokenizer</span><span class="o">=</span><span class="n">TweetTokenizer</span><span class="p">()</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div></div>

<p><strong>Function</strong>  <br />
highlighting the min and max value</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Using Pandas style API for highlighting the min and max for each stat</span>
<span class="k">def</span> <span class="nf">highlight_min</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="s">'''
    highlight the minimum in a Series yellow.
    '''</span>
    <span class="n">is_min</span> <span class="o">=</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">'background-color: red'</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="s">''</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">is_min</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">highlight_max</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="s">'''
    highlight the maximum in a Series yellow.
    '''</span>
    <span class="n">is_max</span> <span class="o">=</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="s">'background-color: green'</span> <span class="k">if</span> <span class="n">v</span> <span class="k">else</span> <span class="s">''</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">is_max</span><span class="p">]</span>
</code></pre></div></div>

<p><strong>Function</strong><br />
define Cramer’s Correlation Stats<br />
두 개의 categorical data에 대한 correlation을 파악할 때에는 cramers V가 optimistic한 방법 중 하나이다</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#https://stackoverflow.com/questions/20892799/using-pandas-calculate-cram%C3%A9rs-coefficient-matrix/39266194</span>
<span class="k">def</span> <span class="nf">cramers_corrected_stat</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">):</span>
    <span class="s">""" calculate Cramers V statistic for categorial-categorial association.
        uses correction from Bergsma and Wicher, 
        Journal of the Korean Statistical Society 42 (2013): 323-328
    """</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">chi2_contingency</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
    <span class="n">phi2</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">/</span><span class="n">n</span>
    <span class="n">r</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">phi2corr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi2</span> <span class="o">-</span> <span class="p">((</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>    
    <span class="n">rcorr</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="p">((</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kcorr</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="p">((</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi2corr</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span> <span class="p">(</span><span class="n">kcorr</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">rcorr</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>

</code></pre></div></div>

<p>Text 전처리</p>
<ul>
  <li>모두 소문자화, ip/user 형식 데이터 삭제, \n 삭제, aphostrophe replacement</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
    <span class="s">"""
    This function receives comments and returns clean word-list
    """</span>
    <span class="c">#Convert to lower case , so that Hi and hi are the same</span>
    <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c">#remove \n</span>
    <span class="n">comment</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"</span><span class="se">\\</span><span class="s">n"</span><span class="p">,</span><span class="s">""</span><span class="p">,</span><span class="n">comment</span><span class="p">)</span>
    <span class="c"># remove leaky elements like ip,user</span>
    <span class="n">comment</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"</span><span class="err">\</span><span class="s">d{1,3}</span><span class="err">\</span><span class="s">.</span><span class="err">\</span><span class="s">d{1,3}</span><span class="err">\</span><span class="s">.</span><span class="err">\</span><span class="s">d{1,3}</span><span class="err">\</span><span class="s">.</span><span class="err">\</span><span class="s">d{1,3}"</span><span class="p">,</span><span class="s">""</span><span class="p">,</span><span class="n">comment</span><span class="p">)</span>
    <span class="c">#removing usernames</span>
    <span class="n">comment</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"</span><span class="err">\</span><span class="s">[</span><span class="err">\</span><span class="s">[.*</span><span class="err">\</span><span class="s">]"</span><span class="p">,</span><span class="s">""</span><span class="p">,</span><span class="n">comment</span><span class="p">)</span>
    
    <span class="c">#Split the sentences into words</span>
    <span class="n">words</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    
    <span class="c"># (')aphostophe  replacement (ie)   you're --&gt; you are  </span>
    <span class="c"># ( basic dictionary lookup : master dictionary present in a hidden block of code)</span>
    <span class="n">words</span><span class="o">=</span><span class="p">[</span><span class="n">APPO</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">APPO</span> <span class="k">else</span> <span class="n">word</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="n">words</span><span class="o">=</span><span class="p">[</span><span class="n">lem</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="s">"v"</span><span class="p">)</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="n">words</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">eng_stopwords</span><span class="p">]</span>
    
    <span class="n">clean_sent</span><span class="o">=</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    <span class="c"># remove any non alphanum,digit character</span>
    <span class="c">#clean_sent=re.sub("\W+"," ",clean_sent)</span>
    <span class="c">#clean_sent=re.sub("  "," ",clean_sent)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">clean_sent</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>TF-IDF(Term Frequency - Inverse Document Frequency)</strong></p>
<ul>
  <li>정보 검색과 텍스트 마이닝에서 이용하는 가중치로, 여러 문서로 이루어진 문서군이 있을 때 어떤 단어가 특정 문서 내에서 얼마나 중요한 것인지를 나타내는 통계적 수치</li>
</ul>

<p>TF-IDF는 단어 빈도와 역문서 빈도의 곱</p>
<ul>
  <li>단어 빈도 tf(t,d)의 경우, 문서 내에 나타나는 해당 단어의 총 빈도수를 사용</li>
  <li>역문서 빈도는 한 단어가 문서 집합 전체에서 얼마나 공통적으로 나타나는지를 나타내는 값</li>
</ul>

<p>특정 문서 내에서 단어 빈도가 높을 수록, 그리고 전체 문서들 중 그 단어를 포함한 문서가 적을 수록 TF-IDF값이 높아짐
따라서 이 값을 이용하면 모든 문서에 흔하게 나타나는 단어를 걸러내는 효과를 얻을 수 있음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#https://buhrmann.github.io/tfidf-analysis.html</span>
<span class="k">def</span> <span class="nf">top_tfidf_feats</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="s">''' Get top n tfidf values in row and return them with their corresponding feature names.'''</span>
    <span class="n">topn_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">row</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">top_n</span><span class="p">]</span>
    <span class="n">top_feats</span> <span class="o">=</span> <span class="p">[(</span><span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">topn_ids</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top_feats</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'feature'</span><span class="p">,</span> <span class="s">'tfidf'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">top_feats_in_doc</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">row_id</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="s">''' Top tfidf features in specific document (matrix row) '''</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">Xtr</span><span class="p">[</span><span class="n">row_id</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">top_tfidf_feats</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">top_mean_feats</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">grp_ids</span><span class="p">,</span> <span class="n">min_tfidf</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span>
    <span class="s">''' Return the top n features that on average are most important amongst documents in rows
        indentified by indices in grp_ids. '''</span>
    
    <span class="n">D</span> <span class="o">=</span> <span class="n">Xtr</span><span class="p">[</span><span class="n">grp_ids</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="n">D</span><span class="p">[</span><span class="n">D</span> <span class="o">&lt;</span> <span class="n">min_tfidf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tfidf_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">top_tfidf_feats</span><span class="p">(</span><span class="n">tfidf_means</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">top_n</span><span class="p">)</span>

<span class="c"># modified for multilabel milticlass</span>
<span class="k">def</span> <span class="nf">top_feats_by_class</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">min_tfidf</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="s">''' Return a list of dfs, where each df holds top_n features and their mean tfidf value
        calculated across documents with the same class label. '''</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols</span><span class="o">=</span><span class="n">train_tags</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">train_tags</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">train_tags</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">feats_df</span> <span class="o">=</span> <span class="n">top_mean_feats</span><span class="p">(</span><span class="n">Xtr</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">min_tfidf</span><span class="o">=</span><span class="n">min_tfidf</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span><span class="p">)</span>
        <span class="n">feats_df</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feats_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfs</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Credis to AlexSanchez https://www.kaggle.com/jhoward/nb-svm-strong-linear-baseline-eda-0-052-lb#261316</span>
<span class="c">#custom NB model</span>

<span class="k">class</span> <span class="nc">NbSvmClassifier</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">ClassifierMixin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">C</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dual</span> <span class="o">=</span> <span class="n">dual</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c"># Verify that model has been fit</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s">'_r'</span><span class="p">,</span> <span class="s">'_clf'</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict_proba</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c"># Verify that model has been fit</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s">'_r'</span><span class="p">,</span> <span class="s">'_clf'</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c"># Check that X and y have correct shape</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">values</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">check_X_y</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">accept_sparse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">pr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_i</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="o">==</span><span class="n">y_i</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">y</span><span class="o">==</span><span class="n">y_i</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_r</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="n">pr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">)))</span>
        <span class="n">x_nb</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clf</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dual</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_nb</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    
<span class="c"># model = NbSvmClassifier(C=4, dual=True, n_jobs=-1)</span>
</code></pre></div></div>

<p>wikipedia에서 제공하는 최근 날짜 기준으로 block된 IP list<br />
blocked IP와 toxic comments는 관련이 높을 관련성이 많으므로 feature engineering 차원에서 하나의 idea로 pick할 수 있음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#https://en.wikipedia.org/wiki/Wikipedia:Database_reports/Indefinitely_blocked_IPs)</span>

<span class="n">blocked_ips</span><span class="o">=</span><span class="p">[</span><span class="s">"216.102.6.176"</span><span class="p">,</span>
<span class="s">"216.120.176.2"</span><span class="p">,</span>
<span class="s">"203.25.150.5"</span><span class="p">,</span>
<span class="s">"203.217.8.30"</span><span class="p">,</span>
<span class="s">"66.90.101.58"</span><span class="p">,</span>
<span class="s">"125.178.86.75"</span><span class="p">,</span>
<span class="s">"210.15.217.194"</span><span class="p">,</span>
<span class="s">"69.36.166.207"</span><span class="p">,</span>
<span class="s">"213.25.24.253"</span><span class="p">,</span>
<span class="s">"24.60.181.235"</span><span class="p">,</span>
<span class="s">"71.204.14.32"</span><span class="p">,</span>
<span class="s">"216.91.92.18"</span><span class="p">,</span>
<span class="s">"212.219.2.4"</span><span class="p">,</span>
<span class="s">"194.74.190.162"</span><span class="p">,</span>
<span class="s">"64.15.152.246"</span><span class="p">,</span>
<span class="s">"59.100.76.166"</span><span class="p">,</span>
<span class="s">"146.145.221.129"</span><span class="p">,</span>
<span class="s">"146.145.221.130"</span><span class="p">,</span>
<span class="s">"74.52.44.34"</span><span class="p">,</span>
<span class="s">"68.5.96.201"</span><span class="p">,</span>
<span class="s">"65.184.176.45"</span><span class="p">,</span>
<span class="s">"209.244.43.209"</span><span class="p">,</span>
<span class="s">"82.46.9.168"</span><span class="p">,</span>
<span class="s">"209.200.236.32"</span><span class="p">,</span>
<span class="s">"209.200.229.181"</span><span class="p">,</span>
<span class="s">"202.181.99.22"</span><span class="p">,</span>
<span class="s">"220.233.226.170"</span><span class="p">,</span>
<span class="s">"212.138.64.178"</span><span class="p">,</span>
<span class="s">"220.233.227.249"</span><span class="p">,</span>
<span class="s">"72.14.194.31"</span><span class="p">,</span>
<span class="s">"72.249.45.0/24"</span><span class="p">,</span>
<span class="s">"72.249.44.0/24"</span><span class="p">,</span>
<span class="s">"80.175.39.213"</span><span class="p">,</span>
<span class="s">"81.109.164.45"</span><span class="p">,</span>
<span class="s">"64.157.15.0/24"</span><span class="p">,</span>
<span class="s">"208.101.10.54"</span><span class="p">,</span>
<span class="s">"216.157.200.254"</span><span class="p">,</span>
<span class="s">"72.14.192.14"</span><span class="p">,</span>
<span class="s">"204.122.16.13"</span><span class="p">,</span>
<span class="s">"217.156.39.245"</span><span class="p">,</span>
<span class="s">"210.11.188.16"</span><span class="p">,</span>
<span class="s">"210.11.188.17"</span><span class="p">,</span>
<span class="s">"210.11.188.18"</span><span class="p">,</span>
<span class="s">"210.11.188.19"</span><span class="p">,</span>
<span class="s">"210.11.188.20"</span><span class="p">,</span>
<span class="s">"64.34.27.153"</span><span class="p">,</span>
<span class="s">"209.68.139.150"</span><span class="p">,</span>
<span class="s">"152.163.100.0/24"</span><span class="p">,</span>
<span class="s">"65.175.48.2"</span><span class="p">,</span>
<span class="s">"131.137.245.197"</span><span class="p">,</span>
<span class="s">"131.137.245.199"</span><span class="p">,</span>
<span class="s">"131.137.245.200"</span><span class="p">,</span>
<span class="s">"64.233.172.37"</span><span class="p">,</span>
<span class="s">"66.99.182.25"</span><span class="p">,</span>
<span class="s">"67.43.21.12"</span><span class="p">,</span>
<span class="s">"66.249.85.85"</span><span class="p">,</span>
<span class="s">"65.175.134.11"</span><span class="p">,</span>
<span class="s">"201.218.3.198"</span><span class="p">,</span>
<span class="s">"193.213.85.12"</span><span class="p">,</span>
<span class="s">"131.137.245.198"</span><span class="p">,</span>
<span class="s">"83.138.189.74"</span><span class="p">,</span>
<span class="s">"72.14.193.163"</span><span class="p">,</span>
<span class="s">"66.249.84.69"</span><span class="p">,</span>
<span class="s">"209.204.71.2"</span><span class="p">,</span>
<span class="s">"80.217.153.189"</span><span class="p">,</span>
<span class="s">"83.138.136.92"</span><span class="p">,</span>
<span class="s">"83.138.136.91"</span><span class="p">,</span>
<span class="s">"83.138.189.75"</span><span class="p">,</span>
<span class="s">"83.138.189.76"</span><span class="p">,</span>
<span class="s">"212.100.250.226"</span><span class="p">,</span>
<span class="s">"212.100.250.225"</span><span class="p">,</span>
<span class="s">"212.159.98.189"</span><span class="p">,</span>
<span class="s">"87.242.116.201"</span><span class="p">,</span>
<span class="s">"74.53.243.18"</span><span class="p">,</span>
<span class="s">"213.219.59.96/27"</span><span class="p">,</span>
<span class="s">"212.219.82.37"</span><span class="p">,</span>
<span class="s">"203.38.149.226"</span><span class="p">,</span>
<span class="s">"66.90.104.22"</span><span class="p">,</span>
<span class="s">"125.16.137.130"</span><span class="p">,</span>
<span class="s">"66.98.128.0/17"</span><span class="p">,</span>
<span class="s">"217.33.236.2"</span><span class="p">,</span>
<span class="s">"24.24.200.113"</span><span class="p">,</span>
<span class="s">"152.22.0.254"</span><span class="p">,</span>
<span class="s">"59.145.89.17"</span><span class="p">,</span>
<span class="s">"71.127.224.0/20"</span><span class="p">,</span>
<span class="s">"65.31.98.71"</span><span class="p">,</span>
<span class="s">"67.53.130.69"</span><span class="p">,</span>
<span class="s">"204.130.130.0/24"</span><span class="p">,</span>
<span class="s">"72.14.193.164"</span><span class="p">,</span>
<span class="s">"65.197.143.214"</span><span class="p">,</span>
<span class="s">"202.60.95.235"</span><span class="p">,</span>
<span class="s">"69.39.89.95"</span><span class="p">,</span>
<span class="s">"88.80.215.14"</span><span class="p">,</span>
<span class="s">"216.218.214.2"</span><span class="p">,</span>
<span class="s">"81.105.175.201"</span><span class="p">,</span>
<span class="s">"203.108.239.12"</span><span class="p">,</span>
<span class="s">"74.220.207.168"</span><span class="p">,</span>
<span class="s">"206.253.55.206"</span><span class="p">,</span>
<span class="s">"206.253.55.207"</span><span class="p">,</span>
<span class="s">"206.253.55.208"</span><span class="p">,</span>
<span class="s">"206.253.55.209"</span><span class="p">,</span>
<span class="s">"206.253.55.210"</span><span class="p">,</span>
<span class="s">"66.64.56.194"</span><span class="p">,</span>
<span class="s">"70.91.90.226"</span><span class="p">,</span>
<span class="s">"209.60.205.96"</span><span class="p">,</span>
<span class="s">"202.173.191.210"</span><span class="p">,</span>
<span class="s">"169.241.10.83"</span><span class="p">,</span>
<span class="s">"91.121.195.205"</span><span class="p">,</span>
<span class="s">"216.70.136.88"</span><span class="p">,</span>
<span class="s">"72.228.151.208"</span><span class="p">,</span>
<span class="s">"66.197.167.120"</span><span class="p">,</span>
<span class="s">"212.219.232.81"</span><span class="p">,</span>
<span class="s">"208.86.225.40"</span><span class="p">,</span>
<span class="s">"63.232.20.2"</span><span class="p">,</span>
<span class="s">"206.219.189.8"</span><span class="p">,</span>
<span class="s">"212.219.14.0/24"</span><span class="p">,</span>
<span class="s">"165.228.71.6"</span><span class="p">,</span>
<span class="s">"99.230.151.129"</span><span class="p">,</span>
<span class="s">"72.91.11.99"</span><span class="p">,</span>
<span class="s">"173.162.177.53"</span><span class="p">,</span>
<span class="s">"60.242.166.182"</span><span class="p">,</span>
<span class="s">"212.219.177.34"</span><span class="p">,</span>
<span class="s">"12.104.27.5"</span><span class="p">,</span>
<span class="s">"85.17.92.13"</span><span class="p">,</span>
<span class="s">"91.198.174.192/27"</span><span class="p">,</span>
<span class="s">"155.246.98.61"</span><span class="p">,</span>
<span class="s">"71.244.123.63"</span><span class="p">,</span>
<span class="s">"81.144.152.130"</span><span class="p">,</span>
<span class="s">"198.135.70.1"</span><span class="p">,</span>
<span class="s">"71.255.126.146"</span><span class="p">,</span>
<span class="s">"74.180.82.59"</span><span class="p">,</span>
<span class="s">"206.158.2.80"</span><span class="p">,</span>
<span class="s">"64.251.53.34"</span><span class="p">,</span>
<span class="s">"24.29.92.238"</span><span class="p">,</span>
<span class="s">"76.254.235.105"</span><span class="p">,</span>
<span class="s">"68.96.242.239"</span><span class="p">,</span>
<span class="s">"203.202.234.226"</span><span class="p">,</span>
<span class="s">"173.72.89.88"</span><span class="p">,</span>
<span class="s">"87.82.229.195"</span><span class="p">,</span>
<span class="s">"68.153.245.37"</span><span class="p">,</span>
<span class="s">"216.240.128.0/19"</span><span class="p">,</span>
<span class="s">"72.46.129.44"</span><span class="p">,</span>
<span class="s">"66.91.35.165"</span><span class="p">,</span>
<span class="s">"82.71.49.124"</span><span class="p">,</span>
<span class="s">"69.132.171.231"</span><span class="p">,</span>
<span class="s">"75.145.183.129"</span><span class="p">,</span>
<span class="s">"194.80.20.237"</span><span class="p">,</span>
<span class="s">"98.207.253.170"</span><span class="p">,</span>
<span class="s">"76.16.222.162"</span><span class="p">,</span>
<span class="s">"66.30.100.130"</span><span class="p">,</span>
<span class="s">"96.22.29.23"</span><span class="p">,</span>
<span class="s">"76.168.140.158"</span><span class="p">,</span>
<span class="s">"202.131.166.252"</span><span class="p">,</span>
<span class="s">"89.207.212.99"</span><span class="p">,</span>
<span class="s">"81.169.155.246"</span><span class="p">,</span>
<span class="s">"216.56.8.66"</span><span class="p">,</span>
<span class="s">"206.15.235.10"</span><span class="p">,</span>
<span class="s">"115.113.95.20"</span><span class="p">,</span>
<span class="s">"204.209.59.11"</span><span class="p">,</span>
<span class="s">"27.33.141.67"</span><span class="p">,</span>
<span class="s">"41.4.65.162"</span><span class="p">,</span>
<span class="s">"99.6.65.6"</span><span class="p">,</span>
<span class="s">"60.234.239.169"</span><span class="p">,</span>
<span class="s">"2620:0:862:101:0:0:2:0/124"</span><span class="p">,</span>
<span class="s">"183.192.165.31"</span><span class="p">,</span>
<span class="s">"50.68.6.12"</span><span class="p">,</span>
<span class="s">"37.214.82.134"</span><span class="p">,</span>
<span class="s">"96.50.0.230"</span><span class="p">,</span>
<span class="s">"60.231.28.109"</span><span class="p">,</span>
<span class="s">"64.90.240.50"</span><span class="p">,</span>
<span class="s">"49.176.97.12"</span><span class="p">,</span>
<span class="s">"209.80.150.137"</span><span class="p">,</span>
<span class="s">"24.22.67.116"</span><span class="p">,</span>
<span class="s">"206.180.81.2"</span><span class="p">,</span>
<span class="s">"195.194.39.100"</span><span class="p">,</span>
<span class="s">"87.41.52.6"</span><span class="p">,</span>
<span class="s">"169.204.164.227"</span><span class="p">,</span>
<span class="s">"50.137.55.117"</span><span class="p">,</span>
<span class="s">"50.77.84.161"</span><span class="p">,</span>
<span class="s">"90.202.230.247"</span><span class="p">,</span>
<span class="s">"186.88.129.224"</span><span class="p">,</span>
<span class="s">"2A02:EC80:101:0:0:0:2:0/124"</span><span class="p">,</span>
<span class="s">"142.4.117.177"</span><span class="p">,</span>
<span class="s">"86.40.105.198"</span><span class="p">,</span>
<span class="s">"120.43.20.149"</span><span class="p">,</span>
<span class="s">"198.199.64.0/18"</span><span class="p">,</span>
<span class="s">"192.34.56.0/21"</span><span class="p">,</span>
<span class="s">"192.81.208.0/20"</span><span class="p">,</span>
<span class="s">"2604:A880:0:0:0:0:0:0/32"</span><span class="p">,</span>
<span class="s">"108.72.107.229"</span><span class="p">,</span>
<span class="s">"2602:306:CC2B:7000:41D3:B92D:731C:959D"</span><span class="p">,</span>
<span class="s">"185.15.59.201"</span><span class="p">,</span>
<span class="s">"180.149.1.229"</span><span class="p">,</span>
<span class="s">"207.191.188.66"</span><span class="p">,</span>
<span class="s">"210.22.63.92"</span><span class="p">,</span>
<span class="s">"117.253.196.217"</span><span class="p">,</span>
<span class="s">"119.160.119.172"</span><span class="p">,</span>
<span class="s">"90.217.133.223"</span><span class="p">,</span>
<span class="s">"194.83.8.3"</span><span class="p">,</span>
<span class="s">"194.83.164.22"</span><span class="p">,</span>
<span class="s">"217.23.228.149"</span><span class="p">,</span>
<span class="s">"65.18.58.1"</span><span class="p">,</span>
<span class="s">"168.11.15.2"</span><span class="p">,</span>
<span class="s">"65.182.127.31"</span><span class="p">,</span>
<span class="s">"207.106.153.252"</span><span class="p">,</span>
<span class="s">"64.193.88.2"</span><span class="p">,</span>
<span class="s">"152.26.71.2"</span><span class="p">,</span>
<span class="s">"199.185.67.179"</span><span class="p">,</span>
<span class="s">"117.90.240.73"</span><span class="p">,</span>
<span class="s">"108.176.58.170"</span><span class="p">,</span>
<span class="s">"195.54.40.28"</span><span class="p">,</span>
<span class="s">"185.35.164.109"</span><span class="p">,</span>
<span class="s">"192.185.0.0/16"</span><span class="p">,</span>
<span class="s">"2605:E000:1605:C0C0:3D3D:A148:3039:71F1"</span><span class="p">,</span>
<span class="s">"107.158.0.0/16"</span><span class="p">,</span>
<span class="s">"85.159.232.0/21"</span><span class="p">,</span>
<span class="s">"69.235.4.10"</span><span class="p">,</span>
<span class="s">"86.176.166.206"</span><span class="p">,</span>
<span class="s">"108.65.152.51"</span><span class="p">,</span>
<span class="s">"10.4.1.0/24"</span><span class="p">,</span>
<span class="s">"103.27.227.139"</span><span class="p">,</span>
<span class="s">"188.55.31.191"</span><span class="p">,</span>
<span class="s">"188.53.13.34"</span><span class="p">,</span>
<span class="s">"176.45.58.252"</span><span class="p">,</span>
<span class="s">"176.45.22.37"</span><span class="p">,</span>
<span class="s">"24.251.44.140"</span><span class="p">,</span>
<span class="s">"108.200.140.191"</span><span class="p">,</span>
<span class="s">"117.177.169.4"</span><span class="p">,</span>
<span class="s">"72.22.162.38"</span><span class="p">,</span>
<span class="s">"24.106.242.82"</span><span class="p">,</span>
<span class="s">"79.125.190.93"</span><span class="p">,</span>
<span class="s">"107.178.200.1"</span><span class="p">,</span>
<span class="s">"123.16.244.246"</span><span class="p">,</span>
<span class="s">"83.228.167.87"</span><span class="p">,</span>
<span class="s">"128.178.197.53"</span><span class="p">,</span>
<span class="s">"14.139.172.18"</span><span class="p">,</span>
<span class="s">"207.108.136.254"</span><span class="p">,</span>
<span class="s">"184.152.17.217"</span><span class="p">,</span>
<span class="s">"186.94.29.73"</span><span class="p">,</span>
<span class="s">"217.200.199.2"</span><span class="p">,</span>
<span class="s">"66.58.141.104"</span><span class="p">,</span>
<span class="s">"166.182.81.30"</span><span class="p">,</span>
<span class="s">"89.168.206.116"</span><span class="p">,</span>
<span class="s">"92.98.163.145"</span><span class="p">,</span>
<span class="s">"77.115.31.71"</span><span class="p">,</span>
<span class="s">"178.36.118.74"</span><span class="p">,</span>
<span class="s">"157.159.10.14"</span><span class="p">,</span>
<span class="s">"103.5.212.139"</span><span class="p">,</span>
<span class="s">"203.174.180.226"</span><span class="p">,</span>
<span class="s">"69.123.252.95"</span><span class="p">,</span>
<span class="s">"199.200.123.233"</span><span class="p">,</span>
<span class="s">"121.45.89.82"</span><span class="p">,</span>
<span class="s">"71.228.87.155"</span><span class="p">,</span>
<span class="s">"68.189.67.92"</span><span class="p">,</span>
<span class="s">"216.161.176.152"</span><span class="p">,</span>
<span class="s">"98.17.30.139"</span><span class="p">,</span>
<span class="s">"2600:1006:B124:84BD:0:0:0:103"</span><span class="p">,</span>
<span class="s">"117.161.0.0/16"</span><span class="p">,</span>
<span class="s">"12.166.68.34"</span><span class="p">,</span>
<span class="s">"96.243.149.64"</span><span class="p">,</span>
<span class="s">"74.143.90.218"</span><span class="p">,</span>
<span class="s">"76.10.176.221"</span><span class="p">,</span>
<span class="s">"104.250.128.0/19"</span><span class="p">,</span>
<span class="s">"185.22.183.128/25"</span><span class="p">,</span>
<span class="s">"89.105.194.64/26"</span><span class="p">,</span>
<span class="s">"202.45.119.0/24"</span><span class="p">,</span>
<span class="s">"73.9.140.64"</span><span class="p">,</span>
<span class="s">"164.127.71.72"</span><span class="p">,</span>
<span class="s">"50.160.129.2"</span><span class="p">,</span>
<span class="s">"49.15.213.207"</span><span class="p">,</span>
<span class="s">"83.7.192.0/18"</span><span class="p">,</span>
<span class="s">"201.174.63.79"</span><span class="p">,</span>
<span class="s">"2A02:C7D:4643:8F00:D09D:BE1:D2DE:BB1F"</span><span class="p">,</span>
<span class="s">"125.60.195.230"</span><span class="p">,</span>
<span class="s">"49.145.113.145"</span><span class="p">,</span>
<span class="s">"168.18.160.134"</span><span class="p">,</span>
<span class="s">"72.193.218.222"</span><span class="p">,</span>
<span class="s">"199.216.164.10"</span><span class="p">,</span>
<span class="s">"120.144.130.89"</span><span class="p">,</span>
<span class="s">"104.130.67.208"</span><span class="p">,</span>
<span class="s">"50.160.221.147"</span><span class="p">,</span>
<span class="s">"163.47.141.50"</span><span class="p">,</span>
<span class="s">"91.200.12.136"</span><span class="p">,</span>
<span class="s">"83.222.0.0/19"</span><span class="p">,</span>
<span class="s">"67.231.16.0/20"</span><span class="p">,</span>
<span class="s">"72.231.0.196"</span><span class="p">,</span>
<span class="s">"180.216.68.197"</span><span class="p">,</span>
<span class="s">"183.160.178.135"</span><span class="p">,</span>
<span class="s">"183.160.176.16"</span><span class="p">,</span>
<span class="s">"24.25.221.150"</span><span class="p">,</span>
<span class="s">"92.222.109.43"</span><span class="p">,</span>
<span class="s">"142.134.243.215"</span><span class="p">,</span>
<span class="s">"216.181.221.72"</span><span class="p">,</span>
<span class="s">"113.205.170.110"</span><span class="p">,</span>
<span class="s">"74.142.2.98"</span><span class="p">,</span>
<span class="s">"192.235.8.3"</span><span class="p">,</span>
<span class="s">"2402:4000:BBFC:36FC:E469:F2F0:9351:71A0"</span><span class="p">,</span>
<span class="s">"80.244.81.191"</span><span class="p">,</span>
<span class="s">"2607:FB90:1377:F765:D45D:46BF:81EA:9773"</span><span class="p">,</span>
<span class="s">"2600:1009:B012:7D88:418B:54BA:FCBC:4584"</span><span class="p">,</span>
<span class="s">"104.237.224.0/19"</span><span class="p">,</span>
<span class="s">"2600:1008:B01B:E495:C05A:7DD3:926:E83C"</span><span class="p">,</span>
<span class="s">"168.8.249.234"</span><span class="p">,</span>
<span class="s">"162.211.179.36"</span><span class="p">,</span>
<span class="s">"138.68.0.0/16"</span><span class="p">,</span>
<span class="s">"145.236.37.195"</span><span class="p">,</span>
<span class="s">"67.205.128.0/18"</span><span class="p">,</span>
<span class="s">"2A02:C7D:2832:CE00:B914:19D6:948D:B37D"</span><span class="p">,</span>
<span class="s">"107.77.203.212"</span><span class="p">,</span>
<span class="s">"2607:FB90:65C:A136:D46F:23BA:87C2:3D10"</span><span class="p">,</span>
<span class="s">"2A02:C7F:DE2F:7900:5D64:E991:FFF0:FA93"</span><span class="p">,</span>
<span class="s">"82.23.32.186"</span><span class="p">,</span>
<span class="s">"106.76.243.74"</span><span class="p">,</span>
<span class="s">"82.33.48.223"</span><span class="p">,</span>
<span class="s">"180.216.160.0/19"</span><span class="p">,</span>
<span class="s">"94.102.184.35"</span><span class="p">,</span>
<span class="s">"94.102.184.26"</span><span class="p">,</span>
<span class="s">"109.92.162.54"</span><span class="p">,</span>
<span class="s">"2600:8800:7180:BF00:4C27:4591:347C:736C"</span><span class="p">,</span>
<span class="s">"178.41.186.50"</span><span class="p">,</span>
<span class="s">"184.97.134.128"</span><span class="p">,</span>
<span class="s">"176.221.32.0/22"</span><span class="p">,</span>
<span class="s">"207.99.40.142"</span><span class="p">,</span>
<span class="s">"109.97.241.134"</span><span class="p">,</span>
<span class="s">"82.136.64.19"</span><span class="p">,</span>
<span class="s">"91.236.74.119"</span><span class="p">,</span>
<span class="s">"197.210.0.0/16"</span><span class="p">,</span>
<span class="s">"173.230.128.0/19"</span><span class="p">,</span>
<span class="s">"162.216.16.0/22"</span><span class="p">,</span>
<span class="s">"80.111.222.211"</span><span class="p">,</span>
<span class="s">"191.37.28.21"</span><span class="p">,</span>
<span class="s">"124.124.103.194"</span><span class="p">,</span>
<span class="s">"50.207.7.198"</span><span class="p">,</span>
<span class="s">"220.233.131.98"</span><span class="p">,</span>
<span class="s">"107.77.241.11"</span><span class="p">,</span>
<span class="s">"68.112.39.0/27"</span><span class="p">,</span>
<span class="s">"173.236.128.0/17"</span><span class="p">,</span>
<span class="s">"49.49.240.24"</span><span class="p">,</span>
<span class="s">"96.31.10.178"</span><span class="p">,</span>
<span class="s">"50.251.229.75"</span><span class="p">]</span>
</code></pre></div></div>

<p>위 clean function에서 사용한 lookup table<br />
aphostrophe 줄임말을 full words로 변환</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#https://drive.google.com/file/d/0B1yuv8YaUVlZZ1RzMFJmc1ZsQmM/view</span>
<span class="c"># Aphost lookup dict</span>
<span class="n">APPO</span> <span class="o">=</span> <span class="p">{</span>
<span class="s">"aren't"</span> <span class="p">:</span> <span class="s">"are not"</span><span class="p">,</span>
<span class="s">"can't"</span> <span class="p">:</span> <span class="s">"cannot"</span><span class="p">,</span>
<span class="s">"couldn't"</span> <span class="p">:</span> <span class="s">"could not"</span><span class="p">,</span>
<span class="s">"didn't"</span> <span class="p">:</span> <span class="s">"did not"</span><span class="p">,</span>
<span class="s">"doesn't"</span> <span class="p">:</span> <span class="s">"does not"</span><span class="p">,</span>
<span class="s">"don't"</span> <span class="p">:</span> <span class="s">"do not"</span><span class="p">,</span>
<span class="s">"hadn't"</span> <span class="p">:</span> <span class="s">"had not"</span><span class="p">,</span>
<span class="s">"hasn't"</span> <span class="p">:</span> <span class="s">"has not"</span><span class="p">,</span>
<span class="s">"haven't"</span> <span class="p">:</span> <span class="s">"have not"</span><span class="p">,</span>
<span class="s">"he'd"</span> <span class="p">:</span> <span class="s">"he would"</span><span class="p">,</span>
<span class="s">"he'll"</span> <span class="p">:</span> <span class="s">"he will"</span><span class="p">,</span>
<span class="s">"he's"</span> <span class="p">:</span> <span class="s">"he is"</span><span class="p">,</span>
<span class="s">"i'd"</span> <span class="p">:</span> <span class="s">"I would"</span><span class="p">,</span>
<span class="s">"i'd"</span> <span class="p">:</span> <span class="s">"I had"</span><span class="p">,</span>
<span class="s">"i'll"</span> <span class="p">:</span> <span class="s">"I will"</span><span class="p">,</span>
<span class="s">"i'm"</span> <span class="p">:</span> <span class="s">"I am"</span><span class="p">,</span>
<span class="s">"isn't"</span> <span class="p">:</span> <span class="s">"is not"</span><span class="p">,</span>
<span class="s">"it's"</span> <span class="p">:</span> <span class="s">"it is"</span><span class="p">,</span>
<span class="s">"it'll"</span><span class="p">:</span><span class="s">"it will"</span><span class="p">,</span>
<span class="s">"i've"</span> <span class="p">:</span> <span class="s">"I have"</span><span class="p">,</span>
<span class="s">"let's"</span> <span class="p">:</span> <span class="s">"let us"</span><span class="p">,</span>
<span class="s">"mightn't"</span> <span class="p">:</span> <span class="s">"might not"</span><span class="p">,</span>
<span class="s">"mustn't"</span> <span class="p">:</span> <span class="s">"must not"</span><span class="p">,</span>
<span class="s">"shan't"</span> <span class="p">:</span> <span class="s">"shall not"</span><span class="p">,</span>
<span class="s">"she'd"</span> <span class="p">:</span> <span class="s">"she would"</span><span class="p">,</span>
<span class="s">"she'll"</span> <span class="p">:</span> <span class="s">"she will"</span><span class="p">,</span>
<span class="s">"she's"</span> <span class="p">:</span> <span class="s">"she is"</span><span class="p">,</span>
<span class="s">"shouldn't"</span> <span class="p">:</span> <span class="s">"should not"</span><span class="p">,</span>
<span class="s">"that's"</span> <span class="p">:</span> <span class="s">"that is"</span><span class="p">,</span>
<span class="s">"there's"</span> <span class="p">:</span> <span class="s">"there is"</span><span class="p">,</span>
<span class="s">"they'd"</span> <span class="p">:</span> <span class="s">"they would"</span><span class="p">,</span>
<span class="s">"they'll"</span> <span class="p">:</span> <span class="s">"they will"</span><span class="p">,</span>
<span class="s">"they're"</span> <span class="p">:</span> <span class="s">"they are"</span><span class="p">,</span>
<span class="s">"they've"</span> <span class="p">:</span> <span class="s">"they have"</span><span class="p">,</span>
<span class="s">"we'd"</span> <span class="p">:</span> <span class="s">"we would"</span><span class="p">,</span>
<span class="s">"we're"</span> <span class="p">:</span> <span class="s">"we are"</span><span class="p">,</span>
<span class="s">"weren't"</span> <span class="p">:</span> <span class="s">"were not"</span><span class="p">,</span>
<span class="s">"we've"</span> <span class="p">:</span> <span class="s">"we have"</span><span class="p">,</span>
<span class="s">"what'll"</span> <span class="p">:</span> <span class="s">"what will"</span><span class="p">,</span>
<span class="s">"what're"</span> <span class="p">:</span> <span class="s">"what are"</span><span class="p">,</span>
<span class="s">"what's"</span> <span class="p">:</span> <span class="s">"what is"</span><span class="p">,</span>
<span class="s">"what've"</span> <span class="p">:</span> <span class="s">"what have"</span><span class="p">,</span>
<span class="s">"where's"</span> <span class="p">:</span> <span class="s">"where is"</span><span class="p">,</span>
<span class="s">"who'd"</span> <span class="p">:</span> <span class="s">"who would"</span><span class="p">,</span>
<span class="s">"who'll"</span> <span class="p">:</span> <span class="s">"who will"</span><span class="p">,</span>
<span class="s">"who're"</span> <span class="p">:</span> <span class="s">"who are"</span><span class="p">,</span>
<span class="s">"who's"</span> <span class="p">:</span> <span class="s">"who is"</span><span class="p">,</span>
<span class="s">"who've"</span> <span class="p">:</span> <span class="s">"who have"</span><span class="p">,</span>
<span class="s">"won't"</span> <span class="p">:</span> <span class="s">"will not"</span><span class="p">,</span>
<span class="s">"wouldn't"</span> <span class="p">:</span> <span class="s">"would not"</span><span class="p">,</span>
<span class="s">"you'd"</span> <span class="p">:</span> <span class="s">"you would"</span><span class="p">,</span>
<span class="s">"you'll"</span> <span class="p">:</span> <span class="s">"you will"</span><span class="p">,</span>
<span class="s">"you're"</span> <span class="p">:</span> <span class="s">"you are"</span><span class="p">,</span>
<span class="s">"you've"</span> <span class="p">:</span> <span class="s">"you have"</span><span class="p">,</span>
<span class="s">"'re"</span><span class="p">:</span> <span class="s">" are"</span><span class="p">,</span>
<span class="s">"wasn't"</span><span class="p">:</span> <span class="s">"was not"</span><span class="p">,</span>
<span class="s">"we'll"</span><span class="p">:</span><span class="s">" will"</span><span class="p">,</span>
<span class="s">"didn't"</span><span class="p">:</span> <span class="s">"did not"</span><span class="p">,</span>
<span class="s">"tryin'"</span><span class="p">:</span><span class="s">"trying"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>raw data loading</p>
<ul>
  <li>\n, 특수기호, (ip/userid) 등 전처리할 것들이 많이 보임.</li>
  <li>각 labeling은 0/1로 표현됨</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'./input/train.csv'</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'./input/test.csv'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                      id                                       comment_text  \
159561  ffd2e85b07b3c7e4  "\nNo he did not, read it again (I would have ...   
159562  ffd72e9766c09c97  "\n Auto guides and the motoring press are not...   
159563  ffe029a7c79dc7fe  "\nplease identify what part of BLP applies be...   
159564  ffe897e7f7182c90  Catalan independentism is the social movement ...   
159565  ffe8b9316245be30  The numbers in parentheses are the additional ...   
159566  ffe987279560d7ff  ":::::And for the second time of asking, when ...   
159567  ffea4adeee384e90  You should be ashamed of yourself \n\nThat is ...   
159568  ffee36eab5c267c9  Spitzer \n\nUmm, theres no actual article for ...   
159569  fff125370e4aaaf3  And it looks like it was actually you who put ...   
159570  fff46fc426af1f9a  "\nAnd ... I really don't think you understand...   

        toxic  severe_toxic  obscene  threat  insult  identity_hate  
159561      0             0        0       0       0              0  
159562      0             0        0       0       0              0  
159563      0             0        0       0       0              0  
159564      0             0        0       0       0              0  
159565      0             0        0       0       0              0  
159566      0             0        0       0       0              0  
159567      0             0        0       0       0              0  
159568      0             0        0       0       0              0  
159569      0             0        0       0       0              0  
159570      0             0        0       0       0              0  
                 id                                       comment_text
0  00001cee341fdb12  Yo bitch Ja Rule is more succesful then you'll...
1  0000247867823ef7  == From RfC == \n\n The title is fine as it is...
2  00013b17ad220c46  " \n\n == Sources == \n\n * Zawe Ashton on Lap...
3  00017563c3f7919a  :If you have a look back at the source, the in...
4  00017695ad8997eb          I don't anonymously edit articles at all.
5  0001ea8717f6de06  Thank you for understanding. I think very high...
6  00024115d4cbde0f  Please do not add nonsense to Wikipedia. Such ...
7  000247e83dcc1211                   :Dear god this site is horrible.
8  00025358d4737918  " \n Only a fool can believe in such numbers. ...
9  00026d1092fe71cc  == Double Redirects == \n\n When fixing double...
</code></pre></div></div>

<p>train data와 test data 크기가 거의 비슷<br />
향후에 train data / test data의 중요 피처에 대한 분포 등이 비슷한지 확인할 필요 있음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nrow_train</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">nrow_test</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">sum</span><span class="o">=</span><span class="n">nrow_train</span><span class="o">+</span><span class="n">nrow_test</span>
<span class="k">print</span><span class="p">(</span><span class="s">"       : train : test"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"rows   :"</span><span class="p">,</span><span class="n">nrow_train</span><span class="p">,</span><span class="s">":"</span><span class="p">,</span><span class="n">nrow_test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"perc   :"</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">nrow_train</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="nb">sum</span><span class="p">),</span><span class="s">"   :"</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">nrow_test</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="nb">sum</span><span class="p">))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       : train : test
rows   : 159571 : 153164
perc   : 51    : 49
</code></pre></div></div>

<h2 id="class-imbalance">Class Imbalance</h2>
<ul>
  <li>class는 ‘clean’과 ‘clean’이 아닌 toxic 관련 comments가 매우 불균형한 상태 (9:1 정도의 비율)</li>
  <li>class는 multi-tagging 되어 있음</li>
  <li>null data는 존재하지 않음 (train/test 모두)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="c">#marking comments without any tags as "clean"</span>
<span class="n">rowsums</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="s">'clean'</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">rowsums</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
<span class="c">#count number of clean entries</span>
<span class="n">train</span><span class="p">[</span><span class="s">'clean'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total comments = "</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total clean comments = "</span><span class="p">,</span><span class="n">train</span><span class="p">[</span><span class="s">'clean'</span><span class="p">]</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total tags ="</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="nb">sum</span><span class="p">())</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Total comments =  159571
Total clean comments =  143346
Total tags = 35098
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>toxic            15294
severe_toxic      1595
obscene           8449
threat             478
insult            7877
identity_hate     1405
dtype: int64
</code></pre></div></div>

<p>아래 결과에는 train/test 모두 null data가 없다고 나오지만, 실제로 test data에 “ “로 표현되어 있어서 NA로 잡히지 않는 data가 1개 존재했음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Check for missing values in Train dataset"</span><span class="p">)</span>
<span class="n">null_check</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">null_check</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Check for missing values in Test dataset"</span><span class="p">)</span>
<span class="n">null_check</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">null_check</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"filling NA with </span><span class="se">\"</span><span class="s">unknown</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span>
<span class="n">train</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">"unknown"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">test</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">"unknown"</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Check for missing values in Train dataset
id               0
comment_text     0
toxic            0
severe_toxic     0
obscene          0
threat           0
insult           0
identity_hate    0
clean            0
dtype: int64
Check for missing values in Test dataset
id              0
comment_text    0
dtype: int64
filling NA with "unknown"
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="c">#plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"# per class"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'# of Occurrences'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Type '</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="c">#adding the text labels</span>
<span class="n">rects</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">patches</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>
<span class="k">for</span> <span class="n">rect</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rects</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">'bottom'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div></div>

<p><img src="/assets/img/output_26_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="o">=</span><span class="n">rowsums</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c">#plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Multiple tags per comment"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'# of Occurrences'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'# of tags '</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c">#adding the text labels</span>
<span class="n">rects</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">patches</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>
<span class="k">for</span> <span class="n">rect</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rects</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">'bottom'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_27_0.png" alt="png" /></p>

<h2 id="correlation-plot">Correlation Plot</h2>

<p><strong>Correlation Coefficient</strong></p>
<ul>
  <li>상관관계의 정도를 파악하는 상관계수(Correlation coefficient)는 두 변수간의 연관된 정도를 나타낼 뿐 인과관계를 설명하는 것은 아님</li>
  <li>두 변수간에 원인과 결과의 인과관계가 있는지에 대한 것은 회귀분석을 통해 인과관계의 방향, 정도와 수학적 모델을 확인해야 함</li>
</ul>

<p><strong>피어슨 상관 계수(Pearson correlation coefficient 또는 Pearson’s r)</strong></p>
<ul>
  <li>피어슨 상관 계수 r은 두 변수간의 관련성을 구하기 위해 보편적으로 이용됨</li>
  <li>연속형 변수 간의 상관관계를 파악할 때 사용(정규분포를 가정하기 때문에 categorical 변수에는 적합하지 않음)</li>
  <li>r = X와 Y가 함께 변하는 정도 / X와 Y가 각각 변하는 정도</li>
</ul>

<p><strong>스피어만 상관 계수</strong></p>
<ul>
  <li>스피어만 상관계수(Spearman correlation coefficient) 는 데이터가 서열척도인 경우 즉 자료의 값 대신 순위를 이용하는 경우의 상관계수(연속형 또는 순서형 변수에 사용 가능)</li>
  <li>데이터를 작은 것부터 차례로 순위를 매겨 서열 순서로 바꾼 뒤 순위를 이용해 상관계수를 구함</li>
  <li>두 변수 간의 연관 관계가 있는지 없는지를 밝혀주며 자료에 이상점이 있거나 표본크기가 작을 때 유용</li>
</ul>

<p>예를 들어, 국어 점수와 영어 점수 간의 상관 계수는 피어슨 상관 계수로, 국어 성적 석차와 영어 성적 석차의 상관 계수는 스피어만 상관 계수로 계산할 수 있다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp_df</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="c"># filter temp by removing clean comments</span>
<span class="c"># temp_df=temp_df[~train.clean]</span>

<span class="n">corr</span><span class="o">=</span><span class="n">temp_df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="n">corr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f1cd0ddae80&gt;
</code></pre></div></div>

<p><img src="/assets/img/output_29_1.png" alt="png" /></p>

<p>위 그래프는 pandas의 corr 함수를 사용한 correlation plot을 보여주는데, 해당 함수는 pearson 상관 계수 값을 표현함으로 categorical data 상관 계수 파악을 위해 적절하지 않음.<br />
따라서 Cramer’s V statistics로 다시 상관 관계 파악</p>

<p>categorical data의 패턴 분석을 위해 아래와 같은 방법이 쓰일 수 있음</p>
<ul>
  <li>ConfusionMatrix / Crosstab (co-occuring frequency table)</li>
  <li>Cramer’s V statistics</li>
</ul>

<p>아래 Crosstab 분석 결과를 보았을 때,</p>
<ul>
  <li>severe_toxic은 toxic에 모두 포함되고</li>
  <li>clean이 아닌 다른 class는 일부분 데이터를 제외하고 대부분 toxic class와 연관성이 깊다</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Crosstab</span>
<span class="c"># Since technically a crosstab between all 6 classes is impossible to vizualize, lets take a </span>
<span class="c"># look at toxic with other tags</span>
<span class="n">main_col</span><span class="o">=</span><span class="s">"toxic"</span>
<span class="n">corr_mats</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">other_col</span> <span class="ow">in</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="n">main_col</span><span class="p">],</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">other_col</span><span class="p">])</span>
    <span class="n">corr_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">corr_mats</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">keys</span><span class="o">=</span><span class="n">temp_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="c">#cell highlighting</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">highlight_min</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">out</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Checking for Toxic and Severe toxic for now</span>

<span class="n">col1</span><span class="o">=</span><span class="s">"toxic"</span>
<span class="n">col2</span><span class="o">=</span><span class="s">"severe_toxic"</span>
<span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">crosstab</span><span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="n">col1</span><span class="p">],</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">col2</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Confusion matrix between toxic and severe toxic:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
<span class="n">new_corr</span><span class="o">=</span><span class="n">cramers_corrected_stat</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"The correlation between Toxic and Severe toxic using Cramer's stat="</span><span class="p">,</span><span class="n">new_corr</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Confusion matrix between toxic and severe toxic:
severe_toxic       0     1
toxic                     
0             144277     0
1              13699  1595
The correlation between Toxic and Severe toxic using Cramer's stat= 0.308502905405
</code></pre></div></div>

<p>Toxic comments에 IP, ID, 숫자 나열 등이 포함되어 있음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"toxic:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">severe_toxic</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"severe_toxic:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">severe_toxic</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Obscene:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">obscene</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">obscene</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"identity_hate:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">identity_hate</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="c">#print(train[train.identity_hate==1].iloc[4,1])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>toxic:
Hi 

Im a fucking bitch.

50.180.208.181



severe_toxic:
What a motherfucking piece of crap those fuckheads for blocking us!



Obscene:
You are gay or antisemmitian? 

Archangel WHite Tiger

Meow! Greetingshhh!

Uh, there are two ways, why you do erased my comment about WW2, that holocaust was brutally slaying of Jews and not gays/Gypsys/Slavs/anyone...

1 - If you are anti-semitian, than shave your head bald and go to the skinhead meetings!

2 - If you doubt words of the Bible, that homosexuality is a deadly sin, make a pentagram tatoo on your forehead go to the satanistic masses with your gay pals!

3 - First and last warning, you fucking gay - I won't appreciate if any more nazi shwain would write in my page! I don't wish to talk to you anymore!

Beware of the Dark Side!
FUCK YOUR FILTHY MOTHER IN THE ASS, DRY!



identity_hate:
u r a tw@ fuck off u gay boy.U r smelly.Fuck ur mum poopie
</code></pre></div></div>

<h2 id="word-cloud">Word Cloud</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">ls</span> <span class="o">./</span><span class="nb">input</span><span class="o">/</span><span class="n">imagesforkernal</span><span class="o">/</span>
<span class="n">stopword</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">STOPWORDS</span><span class="p">)</span>
<span class="c">#print(stopword)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anger.png	      bomb.png	    megaphone.png  swords.png
biohazard-symbol.png  gas-mask.png  safe-zone.png  toxic-sign.png
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">stopword</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{"they're", 'would', 'a', "can't", "hadn't", 'very', "you'd", 'did', "didn't", 'those', "haven't", 'yourselves', 'her', "i've", 'can', 'over', 'there', "here's", 'no', 'if', 'shall', 'cannot', 'hers', "shan't", "i'll", 'ours', 'since', 'once', 'their', 'been', 'any', 'whom', 'other', "who's", "weren't", 'com', 'as', 'or', 'into', "where's", 'for', 'having', 'else', 'until', 'where', 'be', 'like', 'who', 'why', 'www', 'could', "you've", 'is', 'it', 'theirs', "we'd", 'from', 'of', 'she', 'in', 'through', 'against', 'at', 'myself', 'was', 'they', 'nor', "we'll", 'do', 'the', 'on', 'we', 'am', 'doing', 'were', 'being', 'my', 'most', "we've", "won't", 'otherwise', 'ought', 'you', "he's", 'has', "i'm", "how's", 'yours', "when's", "aren't", 'he', 'how', "don't", "why's", 'had', "doesn't", "she'll", "hasn't", "it's", 'them', "she'd", 'only', 'about', 'i', "what's", 'all', 'before', 'themselves', 'then', 'however', "mustn't", "he'd", 'here', 'me', 'own', 'your', 'below', 'between', 'should', 'does', 'this', "he'll", 'up', "wasn't", 'which', "couldn't", 'down', 'further', "she's", "isn't", 'these', 'not', 'few', 'above', 'herself', 'during', 'get', 'have', "there's", 'because', 'are', 'such', 'with', 'again', "we're", "wouldn't", 'him', 'more', "they'll", 'itself', "they'd", "you'll", "you're", 'http', 'k', 'just', 'its', 'our', 'and', "shouldn't", 'what', 'both', 'r', 'when', 'under', 'so', 'an', 'yourself', 'too', 'out', 'same', 'also', 'ourselves', 'after', 'while', "i'd", 'his', 'that', 'but', 'off', "they've", 'himself', 'by', 'each', "that's", 'some', 'than', 'to', 'ever', "let's"}
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#clean comments</span>
<span class="n">clean_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"./input/imagesforkernal/safe-zone.png"</span><span class="p">))</span>
<span class="n">clean_mask</span><span class="o">=</span><span class="n">clean_mask</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
<span class="c">#wordcloud for clean comments</span>
<span class="n">subset</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">clean</span><span class="o">==</span><span class="bp">True</span><span class="p">]</span>
<span class="n">text</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">values</span>
<span class="n">wc</span><span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">background_color</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span><span class="n">max_words</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">clean_mask</span><span class="p">,</span><span class="n">stopwords</span><span class="o">=</span><span class="n">stopword</span><span class="p">)</span>
<span class="n">wc</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Words frequented in Clean Comments"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">colormap</span><span class="o">=</span> <span class="s">'viridis'</span> <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">17</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_38_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">toxic_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"./input/imagesforkernal/toxic-sign.png"</span><span class="p">))</span>
<span class="n">toxic_mask</span><span class="o">=</span><span class="n">toxic_mask</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
<span class="c">#wordcloud for clean comments</span>
<span class="n">subset</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">toxic</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
<span class="n">text</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">values</span>
<span class="n">wc</span><span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">background_color</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span><span class="n">max_words</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">toxic_mask</span><span class="p">,</span><span class="n">stopwords</span><span class="o">=</span><span class="n">stopword</span><span class="p">)</span>
<span class="n">wc</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Words frequented in Toxic Comments"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">colormap</span><span class="o">=</span> <span class="s">'gist_earth'</span> <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">244</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>

<span class="c">#Severely toxic comments</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
<span class="n">severe_toxic_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"./input/imagesforkernal/bomb.png"</span><span class="p">))</span>
<span class="n">severe_toxic_mask</span><span class="o">=</span><span class="n">severe_toxic_mask</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">subset</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">severe_toxic</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
<span class="n">text</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">values</span>
<span class="n">wc</span><span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">background_color</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span><span class="n">max_words</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">severe_toxic_mask</span><span class="p">,</span><span class="n">stopwords</span><span class="o">=</span><span class="n">stopword</span><span class="p">)</span>
<span class="n">wc</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Words frequented in Severe Toxic Comments"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">colormap</span><span class="o">=</span> <span class="s">'Reds'</span> <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">244</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>

<span class="c">#Threat comments</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
<span class="n">threat_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"./input/imagesforkernal/anger.png"</span><span class="p">))</span>
<span class="n">threat_mask</span><span class="o">=</span><span class="n">threat_mask</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">subset</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">threat</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
<span class="n">text</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">values</span>
<span class="n">wc</span><span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">background_color</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span><span class="n">max_words</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">threat_mask</span><span class="p">,</span><span class="n">stopwords</span><span class="o">=</span><span class="n">stopword</span><span class="p">)</span>
<span class="n">wc</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Words frequented in Threatening Comments"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">colormap</span><span class="o">=</span> <span class="s">'summer'</span> <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2534</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>

<span class="c">#insult</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="n">insult_mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">"./input/imagesforkernal/swords.png"</span><span class="p">))</span>
<span class="n">insult_mask</span><span class="o">=</span><span class="n">insult_mask</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span>
<span class="n">subset</span><span class="o">=</span><span class="n">train</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">insult</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
<span class="n">text</span><span class="o">=</span><span class="n">subset</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">values</span>
<span class="n">wc</span><span class="o">=</span> <span class="n">WordCloud</span><span class="p">(</span><span class="n">background_color</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span><span class="n">max_words</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">mask</span><span class="o">=</span><span class="n">insult_mask</span><span class="p">,</span><span class="n">stopwords</span><span class="o">=</span><span class="n">stopword</span><span class="p">)</span>
<span class="n">wc</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="s">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">"off"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Words frequented in insult Comments"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">colormap</span><span class="o">=</span> <span class="s">'Paired_r'</span> <span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">244</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.98</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_39_0.png" alt="png" /></p>

<h2 id="feature-engineering">Feature Engineering</h2>

<p>data를 설명할 수 있을 만한 feature를 더 생성</p>
<ul>
  <li>count_sent / count_word / count_unique_word / count_letters / count_punctuations</li>
  <li>count_words_upper / count_words_title / count_stopwords / mean_word_len</li>
  <li>word_unique_percent / punc_percent</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">merge</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]])</span>
<span class="n">df</span><span class="o">=</span><span class="n">merge</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c">## Indirect features</span>

<span class="c">#Sentense count in each comment:</span>
    <span class="c">#  '\n' can be used to count the number of sentences in each comment</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_sent'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#Word count in each comment:</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_word'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
<span class="c">#Unique word count</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_unique_word'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())))</span>
<span class="c">#Letter count</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_letters'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="c">#punctuation count</span>
<span class="n">df</span><span class="p">[</span><span class="s">"count_punctuations"</span><span class="p">]</span> <span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">]))</span>
<span class="c">#upper case words count</span>
<span class="n">df</span><span class="p">[</span><span class="s">"count_words_upper"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">isupper</span><span class="p">()]))</span>
<span class="c">#title case words count</span>
<span class="n">df</span><span class="p">[</span><span class="s">"count_words_title"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">istitle</span><span class="p">()]))</span>
<span class="c">#Number of stopwords</span>
<span class="n">df</span><span class="p">[</span><span class="s">"count_stopwords"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">eng_stopwords</span><span class="p">]))</span>
<span class="c">#Average length of the words</span>
<span class="n">df</span><span class="p">[</span><span class="s">"mean_word_len"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#derived features</span>
<span class="c">#Word count percent in each comment:</span>
<span class="n">df</span><span class="p">[</span><span class="s">'word_unique_percent'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'count_unique_word'</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s">'count_word'</span><span class="p">]</span>
<span class="c">#derived features</span>
<span class="c">#Punct percent in each comment:</span>
<span class="n">df</span><span class="p">[</span><span class="s">'punct_percent'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'count_punctuations'</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">df</span><span class="p">[</span><span class="s">'count_word'</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#serperate train and test features</span>
<span class="n">train_feats</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">),]</span>
<span class="n">test_feats</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="p">):,]</span>
<span class="c">#join the tags</span>
<span class="n">train_tags</span><span class="o">=</span><span class="n">train</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
<span class="n">train_feats</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_feats</span><span class="p">,</span><span class="n">train_tags</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_feats</span><span class="p">[</span><span class="s">'count_sent'</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_feats</span><span class="p">[</span><span class="s">'count_sent'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="c">## sentenses</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">"Are longer comments more toxic?"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">'count_sent'</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s">'clean'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_feats</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Clean?'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'# of sentences'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Number of sentences in each comment"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="c"># words</span>
<span class="n">train_feats</span><span class="p">[</span><span class="s">'count_word'</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_feats</span><span class="p">[</span><span class="s">'count_word'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">200</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s">'count_word'</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s">'clean'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_feats</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">inner</span><span class="o">=</span><span class="s">"quart"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Clean?'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'# of words'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Number of words in each comment"</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_44_0.png" alt="png" /></p>

<p>문장 길이, 한 문장 안에 포함되는 단어 개수는 toxic 여부와 크게 상관성이 없다.<br />
violin plot은 기존의 box plot을 대체, 중간값, 4분위 표시 등이 가능하고 각 위치의 비율 (해당 count / 전체 count) 포함</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_feats</span><span class="p">[</span><span class="s">'count_unique_word'</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_feats</span><span class="p">[</span><span class="s">'count_unique_word'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">200</span><span class="p">]</span> <span class="o">=</span> <span class="mi">200</span>
<span class="c">#prep for split violin plots</span>
<span class="c">#For the desired plots , the data must be in long format</span>
<span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">train_feats</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s">'count_word'</span><span class="p">,</span> <span class="s">'count_unique_word'</span><span class="p">],</span> <span class="n">id_vars</span><span class="o">=</span><span class="s">'clean'</span><span class="p">)</span>
<span class="c">#spammers - comments with less than 40% unique words</span>
<span class="n">spammers</span><span class="o">=</span><span class="n">train_feats</span><span class="p">[</span><span class="n">train_feats</span><span class="p">[</span><span class="s">'word_unique_percent'</span><span class="p">]</span><span class="o">&lt;</span><span class="mi">30</span><span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">"What's so unique ?"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'variable'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'value'</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s">'clean'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">temp_df</span><span class="p">,</span><span class="n">split</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">inner</span><span class="o">=</span><span class="s">'quartile'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Absolute wordcount and unique words count"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Count'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Percentage of unique words of total words in comment"</span><span class="p">)</span>
<span class="c">#sns.boxplot(x='clean', y='word_unique_percent', data=train_feats)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train_feats</span><span class="p">[</span><span class="n">train_feats</span><span class="o">.</span><span class="n">clean</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">word_unique_percent</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Bad"</span><span class="p">,</span><span class="n">shade</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">'r'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">train_feats</span><span class="p">[</span><span class="n">train_feats</span><span class="o">.</span><span class="n">clean</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">word_unique_percent</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">"Clean"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Number of occurances'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Percent unique words'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">x</span><span class="o">=</span><span class="n">spammers</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Count of comments with low(&lt;30</span><span class="si">%</span><span class="s">) unique words"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">=</span><span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="c">#adding the text labels</span>
<span class="n">rects</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">patches</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>
<span class="k">for</span> <span class="n">rect</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rects</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s">'center'</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s">'bottom'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Threat class'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'# of comments'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_47_0.png" alt="png" /></p>

<p>Word count VS unique word count Features</p>
<ul>
  <li>word count와 unique word count feature에 대해서는 clean/toxic comment 간 차이가 있는 것을 확인할 수 있음</li>
  <li>count / unique count word가 30 이하인 comment에 대해 toxic 관련 밀도가 높은 것을 확인할 수 있음</li>
  <li>unique word가 30개 이하인 comment만 뽑아서 보았을 때 toxic 관련 비율이 월등이 높음 (전체 데이터 셋에서 clean data set이 90% 이상임에도 불구하고)</li>
</ul>

<p>spammer feature 또한 toxic 성격을 더 가지고 있지만 spammer comments 안에 normal word도 포함되기 때문에 이것을 모델에 반영하기에는 위험성이 있음 (예를 들어 mitt romney라는 단어를 toxic word로 규정할 가능성이 있기 때문에)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="s">"Clean Spam example:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">spammers</span><span class="p">[</span><span class="n">spammers</span><span class="o">.</span><span class="n">clean</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Toxic Spam example:"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">spammers</span><span class="p">[</span><span class="n">spammers</span><span class="o">.</span><span class="n">toxic</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Clean Spam example:
Towns and Villages in Ark-La-Tex]]
 Cities, boroughs and towns in the Republic of Ireland
 Cities, boroughs, and townships along the Susquehanna River
 Cities, towns and villages in Alborz Province
 Cities, towns and villages in Ardabil Province
 Cities, towns and villages in Bhutan
 Cities, towns and villages in Bushehr Province
 Cities, towns and villages in Chaharmahal and Bakhtiari Province
 Cities, towns and villages in Cyprus
 Cities, towns and villages in Dutch Limburg
 Cities, towns and villages in East Azerbaijan Province
 Cities, towns and villages in East Timor
 Cities, towns and villages in Fars Province
 Cities, towns and villages in Flevoland
 Cities, towns and villages in Friesland
 Cities, towns and villages in Gelderland
 Cities, towns and villages in Gilan Province
 Cities, towns and villages in Golestan Province
 Cities, towns and villages in Groningen
 Cities, towns and villages in Hamadan Province
 Cities, towns and villages in Hormozgan Province
 Cities, towns and villages in Ilam Province
 Cities, towns and villages in Isfahan Province
 Cities, towns and villages in Kerman Province
 Cities, towns and villages in Kermanshah Province
 Cities, towns and villages in Khuzestan Province
 Cities, towns and villages in Kohgiluyeh and Boyer-Ahmad Province
 Cities, towns and villages in Kurdistan Province
 Cities, towns and villages in Lorestan Province
 Cities, towns and villages in Markazi Province
 Cities, towns and villages in Mazandaran Province
 Cities, towns and villages in North Brabant
 Cities, towns and villages in North Holland
 Cities, towns and villages in North Khorasan Province
 Cities, towns and villages in Overijssel
 Cities, towns and villages in Qazvin Province
 Cities, towns and villages in Qom Province
 Cities, towns and villages in Razavi Khorasan Province
 Cities, towns and villages in Saint Vincent and the Grenadines
 Cities, towns and villages in Samoa
 Cities, towns and villages in Semnan Province
 Cities, towns and villages in Sistan and Baluchestan Province
 Cities, towns and villages in South Holland
 Cities, towns and villages in South Khorasan Province
 Cities, towns and villages in Tehran Province
 Cities, towns and villages in Turkmenistan
 Cities, towns and villages in Utrecht
 Cities, towns and villages in Vojvodina
 Cities, towns and villages in West Azerbaijan Province
 Cities, towns and villages in Yazd Province
 Cities, towns and villages in Zanjan Province
 Cities, towns and villages in Zeeland
 Cities, towns and villages in the Maldives
 Cities, towns and villages in the Solomon Islands
 Cities, towns, and villages in Békés county
 Cities, towns, and villages in Louisiana
Toxic Spam example:
User:NHRHS2010 is a homo like mitt romney is. 
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.
 User:NHRHS2010 is a homo like mitt romney is. 
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. 
User:Enigmaman is a homo like mitt romney is.== User:NHRHS2010 is a homo like mitt romney is. ==
User:NHRHS2010 is a homo like mitt romney is.
 User:Enigmaman is a homo like mitt romney is. NEWL
</code></pre></div></div>

<p><strong>Leaky feature</strong></p>
<ul>
  <li>ip / count_ip / link / count_links / article_id / article_id_flag / username / count_username</li>
</ul>

<p><strong>feature engineering 할 때 direct feature 보다 indirect / leaky feature를 먼저 생성하고 확인해보는 것이 좋음</strong>  <br />
direct feature (count 관련 features)는 clean corpus에서 유효하고, leaky feature은 데이터 전처리에서 발생할 수 있는 정보 손실에 대해 보충해 줄 수 있는 역할을 할 수 있음</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Leaky features</span>
<span class="n">df</span><span class="p">[</span><span class="s">'ip'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"</span><span class="err">\</span><span class="s">d{1,3}</span><span class="err">\</span><span class="s">.</span><span class="err">\</span><span class="s">d{1,3}</span><span class="err">\</span><span class="s">.</span><span class="err">\</span><span class="s">d{1,3}</span><span class="err">\</span><span class="s">.</span><span class="err">\</span><span class="s">d{1,3}"</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="c">#count of ip addresses</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_ip'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"ip"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c">#links</span>
<span class="n">df</span><span class="p">[</span><span class="s">'link'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"http://.*com"</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="c">#count of links</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_links'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"link"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c">#article ids</span>
<span class="n">df</span><span class="p">[</span><span class="s">'article_id'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"</span><span class="err">\</span><span class="s">d:</span><span class="err">\</span><span class="s">d</span><span class="err">\</span><span class="s">d</span><span class="err">\</span><span class="s">s{0,5}$"</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="n">df</span><span class="p">[</span><span class="s">'article_id_flag'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">article_id</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c">#username</span>
<span class="c">##              regex for     Match anything with [[User: ---------- ]]</span>
<span class="c"># regexp = re.compile("\[\[User:(.*)\|")</span>
<span class="n">df</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"comment_text"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">"</span><span class="err">\</span><span class="s">[</span><span class="err">\</span><span class="s">[User(.*)</span><span class="err">\</span><span class="s">|"</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
<span class="c">#count of username mentions</span>
<span class="n">df</span><span class="p">[</span><span class="s">'count_usernames'</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">"username"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="c">#check if features are created</span>
<span class="c">#df.username[df.count_usernames&gt;0]</span>

<span class="c"># Leaky Ip</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
<span class="n">count_feats_ip</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">"ip"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>


<span class="c"># Leaky usernames</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">()</span>
<span class="n">count_feats_user</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">"username"</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">count_usernames</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">comment_text</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'2010]]\n[[User talk:Wikireader41/Archive4|Archive 5-Mar 15'
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># check few names</span>
<span class="n">cv</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()[</span><span class="mi">120</span><span class="p">:</span><span class="mi">130</span><span class="p">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>['destruction',
 'diablo',
 'diligent',
 'dland',
 'dlohcierekim',
 'dodo',
 'dominick',
 'douglas',
 'dpl',
 'dr']
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">leaky_feats</span><span class="o">=</span><span class="n">df</span><span class="p">[[</span><span class="s">"ip"</span><span class="p">,</span><span class="s">"link"</span><span class="p">,</span><span class="s">"article_id"</span><span class="p">,</span><span class="s">"username"</span><span class="p">,</span><span class="s">"count_ip"</span><span class="p">,</span><span class="s">"count_links"</span><span class="p">,</span><span class="s">"count_usernames"</span><span class="p">,</span><span class="s">"article_id_flag"</span><span class="p">]]</span>
<span class="n">leaky_feats_train</span><span class="o">=</span><span class="n">leaky_feats</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">leaky_feats_test</span><span class="o">=</span><span class="n">leaky_feats</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#filterout the entries without ips</span>
<span class="n">train_ips</span><span class="o">=</span><span class="n">leaky_feats_train</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="n">leaky_feats_train</span><span class="o">.</span><span class="n">count_ip</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_ips</span><span class="o">=</span><span class="n">leaky_feats_test</span><span class="o">.</span><span class="n">ip</span><span class="p">[</span><span class="n">leaky_feats_test</span><span class="o">.</span><span class="n">count_ip</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="c">#get the unique list of ips in test and train datasets</span>
<span class="n">train_ip_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">train_ips</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
<span class="n">test_ip_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_ips</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

<span class="c"># get common elements</span>
<span class="n">common_ip_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_ip_list</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">test_ip_list</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Common IP addresses"</span><span class="p">)</span>
<span class="n">venn</span><span class="o">.</span><span class="n">venn2</span><span class="p">(</span><span class="n">subsets</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_ip_list</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">test_ip_list</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">common_ip_list</span><span class="p">)),</span><span class="n">set_labels</span><span class="o">=</span><span class="p">(</span><span class="s">"# of unique IP in train"</span><span class="p">,</span><span class="s">"# of unique IP in test"</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_56_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#filterout the entries without links</span>
<span class="n">train_links</span><span class="o">=</span><span class="n">leaky_feats_train</span><span class="o">.</span><span class="n">link</span><span class="p">[</span><span class="n">leaky_feats_train</span><span class="o">.</span><span class="n">count_links</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_links</span><span class="o">=</span><span class="n">leaky_feats_test</span><span class="o">.</span><span class="n">link</span><span class="p">[</span><span class="n">leaky_feats_test</span><span class="o">.</span><span class="n">count_links</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="c">#get the unique list of ips in test and train datasets</span>
<span class="n">train_links_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">train_links</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
<span class="n">test_links_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_links</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

<span class="c"># get common elements</span>
<span class="n">common_links_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_links_list</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">test_links_list</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Common links"</span><span class="p">)</span>
<span class="n">venn</span><span class="o">.</span><span class="n">venn2</span><span class="p">(</span><span class="n">subsets</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_links_list</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">test_links_list</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">common_links_list</span><span class="p">)),</span>
           <span class="n">set_labels</span><span class="o">=</span><span class="p">(</span><span class="s">"# of unique links in train"</span><span class="p">,</span><span class="s">"# of unique links in test"</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_57_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#filterout the entries without users</span>
<span class="n">train_users</span><span class="o">=</span><span class="n">leaky_feats_train</span><span class="o">.</span><span class="n">username</span><span class="p">[</span><span class="n">leaky_feats_train</span><span class="o">.</span><span class="n">count_usernames</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="n">test_users</span><span class="o">=</span><span class="n">leaky_feats_test</span><span class="o">.</span><span class="n">username</span><span class="p">[</span><span class="n">leaky_feats_test</span><span class="o">.</span><span class="n">count_usernames</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
<span class="c">#get the unique list of ips in test and train datasets</span>
<span class="n">train_users_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">train_users</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
<span class="n">test_users_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_users</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

<span class="c"># get common elements</span>
<span class="n">common_users_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_users_list</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">test_users_list</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"Common usernames"</span><span class="p">)</span>
<span class="n">venn</span><span class="o">.</span><span class="n">venn2</span><span class="p">(</span><span class="n">subsets</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_users_list</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">test_users_list</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">common_users_list</span><span class="p">)),</span>
           <span class="n">set_labels</span><span class="o">=</span><span class="p">(</span><span class="s">"# of unique Usernames in train"</span><span class="p">,</span><span class="s">"# of unique usernames in test"</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_58_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_ip_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">train_ips</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
<span class="n">test_ip_list</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_ips</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

<span class="c"># get common elements</span>
<span class="n">blocked_ip_list_train</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_ip_list</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">blocked_ips</span><span class="p">))</span>
<span class="n">blocked_ip_list_test</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">test_ip_list</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">blocked_ips</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s">"There are"</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_ip_list_train</span><span class="p">),</span><span class="s">"blocked IPs in train dataset"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"There are"</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">blocked_ip_list_test</span><span class="p">),</span><span class="s">"blocked IPs in test dataset"</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>There are 6 blocked IPs in train dataset
There are 0 blocked IPs in test dataset
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till Leaky feats"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total time till Leaky feats 5089.553529024124
</code></pre></div></div>

<p>unique ip / link가 train / test 데이터에서 중복되는 것이 있으므로 feature engineering에서 사용 가능 (username은 겹치는 것이 한 개 밖에 없음)<br />
wikipedia에서 받아온 blocked ip도 train dataset에서 6개 발견됨</p>

<h2 id="corpus-cleansing">Corpus Cleansing</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">corpus</span><span class="o">=</span><span class="n">merge</span><span class="o">.</span><span class="n">comment_text</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">12235</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n\n</span><span class="s">'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">clean</span><span class="p">(</span><span class="n">corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">12235</span><span class="p">]))</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"

 NOTE If you read above, and follow the links, any reader can see that I cited correctly the links I added on this subject. Vidkun has added anotations to make them read as the oposite, but these links show the ""official"" line taken by UGLE. I will not be trapped by any User into so-called 3RR, so he can peddle his POV. Strangly, ALL other ""MASONS"" are quiet, leaving ‘‘me’’ to defend that factual truth on my own. ""Thanks"" Brethren. Sitting any blocking out if given...  "



" note read , follow link , reader see cite correctly link add subject . vidkun add anotations make read oposite , link show " " official " " line take ugle . trap user so-called 3rr , peddle pov . strangly , " " masons " " quiet , leave ‘ ‘ ’ ’ defend factual truth . " " thank " " brethren . sit block give ... "
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">clean_corpus</span><span class="o">=</span><span class="n">corpus</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span><span class="n">clean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till Cleaning"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total time till Cleaning 9700.285007715225
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># To do next:</span>
<span class="c"># Slang lookup dictionary for sentiments</span>
<span class="c">#http://slangsd.com/data/SlangSD.zip</span>
<span class="c">#http://arxiv.org/abs/1608.05129</span>
<span class="c"># dict lookup </span>
<span class="c">#https://bytes.com/topic/python/answers/694819-regular-expression-dictionary-key-search</span>
</code></pre></div></div>

<p><strong>Direct features (uni-gram)</strong><br />
count 관련 direct feature를 생성하기 위해 아래와 같은 방법 사용 가능</p>
<ul>
  <li>CountVectorizer</li>
  <li>TF-IDF Vectorizer</li>
  <li>HashingVectorizer : vocabulary에 대해서 dictionary 대신 hashmap 제공, scalable &amp; faster</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">### Unigrams -- TF-IDF </span>
<span class="c"># using settings recommended here for TF-IDF -- https://www.kaggle.com/abhishek/approaching-almost-any-nlp-problem-on-kaggle</span>

<span class="c">#some detailed description of the parameters</span>
<span class="c"># min_df=10 --- ignore terms that appear lesser than 10 times </span>
<span class="c"># max_features=None  --- Create as many words as present in the text corpus</span>
    <span class="c"># changing max_features to 10k for memmory issues</span>
<span class="c"># analyzer='word'  --- Create features from words (alternatively char can also be used)</span>
<span class="c"># ngram_range=(1,1)  --- Use only one word at a time (unigrams)</span>
<span class="c"># strip_accents='unicode' -- removes accents</span>
<span class="c"># use_idf=1,smooth_idf=1 --- enable IDF</span>
<span class="c"># sublinear_tf=1   --- Apply sublinear tf scaling, i.e. replace tf with 1 + log(tf)</span>


<span class="c">#temp settings to min=200 to facilitate top features section to run in kernals</span>
<span class="c">#change back to min=10 to get better results</span>
<span class="n">start_unigrams</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">tfv</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">min_df</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>  <span class="n">max_features</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> 
            <span class="n">strip_accents</span><span class="o">=</span><span class="s">'unicode'</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">=</span><span class="s">'word'</span><span class="p">,</span><span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">use_idf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">smooth_idf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sublinear_tf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">stop_words</span> <span class="o">=</span> <span class="s">'english'</span><span class="p">)</span>
<span class="n">tfv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clean_corpus</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tfv</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())</span>

<span class="n">train_unigrams</span> <span class="o">=</span>  <span class="n">tfv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">test_unigrams</span> <span class="o">=</span> <span class="n">tfv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#get top n for unigrams</span>
<span class="n">tfidf_top_n_per_lass</span><span class="o">=</span><span class="n">top_feats_by_class</span><span class="p">(</span><span class="n">train_unigrams</span><span class="p">,</span><span class="n">features</span><span class="p">)</span>

<span class="n">end_unigrams</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">"total time in unigrams"</span><span class="p">,</span><span class="n">end_unigrams</span><span class="o">-</span><span class="n">start_unigrams</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till unigrams"</span><span class="p">,</span><span class="n">end_unigrams</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total time in unigrams 65.25758147239685
total time till unigrams 9778.263393878937
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">22</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">"TF_IDF Top words per class(unigrams)"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Toxic"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Severe toxic"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Obscene"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Threat"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Insult"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Identity hate"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">19</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Clean"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div></div>

<p><img src="/assets/img/output_70_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#temp settings to min=150 to facilitate top features section to run in kernals</span>
<span class="c">#change back to min=10 to get better results</span>
<span class="n">tfv</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">min_df</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>  <span class="n">max_features</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> 
            <span class="n">strip_accents</span><span class="o">=</span><span class="s">'unicode'</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">=</span><span class="s">'word'</span><span class="p">,</span><span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">use_idf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">smooth_idf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sublinear_tf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">stop_words</span> <span class="o">=</span> <span class="s">'english'</span><span class="p">)</span>

<span class="n">tfv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clean_corpus</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tfv</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())</span>
<span class="n">train_bigrams</span> <span class="o">=</span>  <span class="n">tfv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">test_bigrams</span> <span class="o">=</span> <span class="n">tfv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:])</span>
<span class="c">#get top n for bigrams</span>
<span class="n">tfidf_top_n_per_lass</span><span class="o">=</span><span class="n">top_feats_by_class</span><span class="p">(</span><span class="n">train_bigrams</span><span class="p">,</span><span class="n">features</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">22</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">"TF_IDF Top words per class(Bigrams)"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Toxic"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Severe toxic"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Obscene"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Threat"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Insult"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Identity hate"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">],</span><span class="n">tfidf_top_n_per_lass</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">tfidf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Clean"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Word'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'TF-IDF score'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_72_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till bigrams"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total time till bigrams 9908.182485342026
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tfv</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">min_df</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="n">max_features</span><span class="o">=</span><span class="mi">30000</span><span class="p">,</span> 
            <span class="n">strip_accents</span><span class="o">=</span><span class="s">'unicode'</span><span class="p">,</span> <span class="n">analyzer</span><span class="o">=</span><span class="s">'char'</span><span class="p">,</span><span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
            <span class="n">use_idf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">smooth_idf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">sublinear_tf</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">stop_words</span> <span class="o">=</span> <span class="s">'english'</span><span class="p">)</span>

<span class="n">tfv</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clean_corpus</span><span class="p">)</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tfv</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())</span>
<span class="n">train_charngrams</span> <span class="o">=</span>  <span class="n">tfv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">test_charngrams</span> <span class="o">=</span> <span class="n">tfv</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">clean_corpus</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:])</span>
<span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till charngrams"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total time till charngrams 10267.063734769821
</code></pre></div></div>

<h2 id="baseline-model">Baseline Model</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SELECTED_COLS</span><span class="o">=</span><span class="p">[</span><span class="s">'count_sent'</span><span class="p">,</span> <span class="s">'count_word'</span><span class="p">,</span> <span class="s">'count_unique_word'</span><span class="p">,</span>
       <span class="s">'count_letters'</span><span class="p">,</span> <span class="s">'count_punctuations'</span><span class="p">,</span> <span class="s">'count_words_upper'</span><span class="p">,</span>
       <span class="s">'count_words_title'</span><span class="p">,</span> <span class="s">'count_stopwords'</span><span class="p">,</span> <span class="s">'mean_word_len'</span><span class="p">,</span>
       <span class="s">'word_unique_percent'</span><span class="p">,</span> <span class="s">'punct_percent'</span><span class="p">]</span>
<span class="n">target_x</span><span class="o">=</span><span class="n">train_feats</span><span class="p">[</span><span class="n">SELECTED_COLS</span><span class="p">]</span>
<span class="c"># target_x</span>

<span class="n">TARGET_COLS</span><span class="o">=</span><span class="p">[</span><span class="s">'toxic'</span><span class="p">,</span> <span class="s">'severe_toxic'</span><span class="p">,</span> <span class="s">'obscene'</span><span class="p">,</span> <span class="s">'threat'</span><span class="p">,</span> <span class="s">'insult'</span><span class="p">,</span> <span class="s">'identity_hate'</span><span class="p">]</span>
<span class="n">target_y</span><span class="o">=</span><span class="n">train_tags</span><span class="p">[</span><span class="n">TARGET_COLS</span><span class="p">]</span>

<span class="c"># Strat k fold due to imbalanced classes</span>
<span class="c"># split = StratifiedKFold(n_splits=2, random_state=1)</span>

<span class="c">#https://www.kaggle.com/yekenot/toxic-regression</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Just the indirect features -- meta features</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Using only Indirect features"</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">importance</span><span class="o">=</span><span class="p">[]</span>
<span class="n">preds_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="n">preds_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TARGET_COLS</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Class:= '</span><span class="o">+</span><span class="n">j</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">preds_valid</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">preds_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">train_loss_class</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">preds_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
    <span class="n">valid_loss_class</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_valid</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">preds_valid</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Trainloss=log loss:'</span><span class="p">,</span> <span class="n">train_loss_class</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Validloss=log loss:'</span><span class="p">,</span> <span class="n">valid_loss_class</span><span class="p">)</span>
    <span class="n">importance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">coef_</span><span class="p">)</span>
    <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss_class</span><span class="p">)</span>
    <span class="n">valid_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_loss_class</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'mean column-wise log loss:Train dataset'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_loss</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'mean column-wise log loss:Validation dataset'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_loss</span><span class="p">))</span>

<span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till Indirect feat model"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using only Indirect features
Class:= toxic
Trainloss=log loss: 0.301237967533
Validloss=log loss: 0.30032310643
Class:= severe_toxic
Trainloss=log loss: 0.0504951244796
Validloss=log loss: 0.0516744563043
Class:= obscene
Trainloss=log loss: 0.199751128693
Validloss=log loss: 0.198056892129
Class:= threat
Trainloss=log loss: 0.0197706692938
Validloss=log loss: 0.0192285118749
Class:= insult
Trainloss=log loss: 0.188593425839
Validloss=log loss: 0.189818523181
Class:= identity_hate
Trainloss=log loss: 0.0478277367533
Validloss=log loss: 0.0513427824
mean column-wise log loss:Train dataset 0.134612675432
mean column-wise log loss:Validation dataset 0.135074045387
total time till Indirect feat model 10528.657516002655
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">importance</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([  3.68238420e-02,   1.36417093e-05,  -2.23852462e-02,
         2.11721313e-04,   1.33385156e-03,   5.04105088e-02,
        -1.80732670e-02,   4.57792577e-03,  -1.57922696e-03,
        -7.85326544e-03,  -2.75729242e-05])
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">22</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">"Feature importance for indirect features"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">SELECTED_COLS</span><span class="p">,</span><span class="n">importance</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Toxic"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">SELECTED_COLS</span><span class="p">,</span><span class="n">importance</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Severe toxic"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">SELECTED_COLS</span><span class="p">,</span><span class="n">importance</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Obscene"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>



<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">SELECTED_COLS</span><span class="p">,</span><span class="n">importance</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Threat"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">SELECTED_COLS</span><span class="p">,</span><span class="n">importance</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Insult"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">SELECTED_COLS</span><span class="p">,</span><span class="n">importance</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">"class : Identity hate"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">locs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Feature'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Importance'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


<span class="c"># plt.subplot2grid((4,2),(3,0),colspan=2)</span>
<span class="c"># sns.barplot(SELECTED_COLS,importance[6][0],color=color[0])</span>
<span class="c"># plt.title("class : Clean",fontsize=15)</span>
<span class="c"># locs, labels = plt.xticks()</span>
<span class="c"># plt.setp(labels, rotation=90)</span>
<span class="c"># plt.xlabel('Feature', fontsize=12)</span>
<span class="c"># plt.ylabel('Importance', fontsize=12)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/assets/img/output_79_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span><span class="p">,</span> <span class="n">hstack</span>

<span class="c">#Using all direct features</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Using all features except leaky ones"</span><span class="p">)</span>
<span class="n">target_x</span> <span class="o">=</span> <span class="n">hstack</span><span class="p">((</span><span class="n">train_bigrams</span><span class="p">,</span><span class="n">train_charngrams</span><span class="p">,</span><span class="n">train_unigrams</span><span class="p">,</span><span class="n">train_feats</span><span class="p">[</span><span class="n">SELECTED_COLS</span><span class="p">]))</span><span class="o">.</span><span class="n">tocsr</span><span class="p">()</span>


<span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till Sparse mat creation"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Using all features except leaky ones
total time till Sparse mat creation 6182.611257553101
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">NbSvmClassifier</span><span class="p">(</span><span class="n">C</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dual</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">2018</span><span class="p">)</span>
<span class="n">train_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">valid_loss</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">preds_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)))</span>
<span class="n">preds_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">TARGET_COLS</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Class:= '</span><span class="o">+</span><span class="n">j</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">preds_valid</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">preds_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_train</span><span class="p">)[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">train_loss_class</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_train</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">preds_train</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
    <span class="n">valid_loss_class</span><span class="o">=</span><span class="n">log_loss</span><span class="p">(</span><span class="n">y_valid</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">preds_valid</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Trainloss=log loss:'</span><span class="p">,</span> <span class="n">train_loss_class</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Validloss=log loss:'</span><span class="p">,</span> <span class="n">valid_loss_class</span><span class="p">)</span>
    <span class="n">train_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss_class</span><span class="p">)</span>
    <span class="n">valid_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">valid_loss_class</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'mean column-wise log loss:Train dataset'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">train_loss</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'mean column-wise log loss:Validation dataset'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_loss</span><span class="p">))</span>


<span class="n">end_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"total time till NB base model creation"</span><span class="p">,</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Class:= toxic
Trainloss=log loss: 0.205595383099
Validloss=log loss: 0.212099929672
Class:= severe_toxic
Trainloss=log loss: 0.0275418257248
Validloss=log loss: 0.0351199133935
Class:= obscene
Trainloss=log loss: 0.0844451353305
Validloss=log loss: 0.084862859268
Class:= threat
Trainloss=log loss: 0.00848696749366
Validloss=log loss: 0.0124603198435
Class:= insult
Trainloss=log loss: 0.107969254792
Validloss=log loss: 0.125174226428
Class:= identity_hate
Trainloss=log loss: 0.0252597208669
Validloss=log loss: 0.0394371571027
mean column-wise log loss:Train dataset 0.0765497145513
mean column-wise log loss:Validation dataset 0.084859067618
total time till NB base model creation 6481.256872415543
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'''
Topic modeling:
Due to kernal limitations(kernal timeout at 3600s), I had to continue the exploration in a seperate kernal( Understanding the "Topic" of toxicity) to aviod a timeout.

Next steps:
Add Glove vector features
Explore sentiement scores
Add LSTM, LGBM
'''</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\nTopic modeling:\nDue to kernal limitations(kernal timeout at 3600s), I had to continue the exploration in a seperate kernal( Understanding the "Topic" of toxicity) to aviod a timeout.\n\nNext steps:\nAdd Glove vector features\nExplore sentiement scores\nAdd LSTM, LGBM\n'
</code></pre></div></div>

<h2 id="이-커널의-check-point">이 커널의 Check Point</h2>
<ul>
  <li>Class Imbalance (Strat K fold)</li>
  <li>Correlation plot (in numeric &amp; categorycal data)</li>
  <li>violin plot</li>
</ul>

<h2 id="reference">Reference</h2>
<ul>
  <li>https://www.kaggle.com/jagangupta/stop-the-s-toxic-comments-eda</li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#data-analysis" class="page__taxonomy-item" rel="tag">Data Analysis</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#eda" class="page__taxonomy-item" rel="tag">EDA</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#kaggle" class="page__taxonomy-item" rel="tag">Kaggle</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#toxic-classification" class="page__taxonomy-item" rel="tag">toxic classification</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#data-analysis" class="page__taxonomy-item" rel="tag">Data Analysis</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time datetime="2018-10-09T00:00:00+09:00">October 09, 2018</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/writing/sapiens_inji/" class="pagination--pager" title="사피엔스 필사1_인지혁명
">이전</a>
    
    
      <a href="/data%20analysis/Toxic_Preprocessing/" class="pagination--pager" title="Kaggle Toxic Classification (2) Preprocessing
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">참고</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/kaggle_kernel/" rel="permalink">Kaggle_kernel
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/writing/sapiens_nongup/" rel="permalink">사피엔스 필사2_농업혁명
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">사피엔스 제 2장. 농업혁명 관련 필사
(손 필사… 힘들다… ;;)
  












</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/writing/thougts/" rel="permalink">감옥으로부터의 사색 중에서
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">
  없는 사람이 살기는 겨울보다 여름이 낫다고 하지만 교도소의 우리들은 없이 살기는 더합니다만 차라리 겨울을 택합니다. 왜냐하면 여름 징역의 열 가지 스무 가지 장점을 일시에 무색케 해버리는 결정적인 사실 ― 여름 징역은 자기의 바로 옆사람을 증오하게 한다는 사실 때문입니다.

...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/data%20analysis/Toxic_Preprocessing/" rel="permalink">Kaggle Toxic Classification (2) Preprocessing
</a>
      
    </h2>
    
    <p class="archive__item-excerpt" itemprop="description">Toxic Comment Classification Kaggle 대회 : 링크

</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
  <input type="text" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  <div id="results" class="results"></div>
</div>
      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    
    
    
    
      <li><a href="https://github.com/InspiringPeople"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
	
      <li><a href="https://youtube.com/dearpiano"><i class="fab fa-fw fa-youtube" aria-hidden="true"></i> youtube</a></li>
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 YounKyung Jang. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>


      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-121538180-1']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/data%20analysis/Toxic_EDA/";  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = "/data%20analysis/Toxic_EDA"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://https-inspiringpeople-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  



  </body>
</html>